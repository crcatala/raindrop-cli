name: Live Tests

on:
  pull_request:
    branches: [main]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Run in verbose mode'
        type: boolean
        default: false

jobs:
  # Shows as a skipped check on PRs with instructions
  live-tests-pending:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Live tests available on demand
        run: |
          echo "::notice::Live tests skipped by default. Comment '/run-live-tests' on this PR to trigger them."
          echo ""
          echo "Live API tests are not run automatically to avoid requiring credentials."
          echo "To run live tests, add a comment with: /run-live-tests"

  # Runs when someone comments /run-live-tests on a PR
  live-tests:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/run-live-tests'))
    runs-on: ubuntu-latest

    steps:
      - name: Get PR head ref
        if: github.event_name == 'issue_comment'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.ref || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run live tests
        env:
          RAINDROP_TOKEN: ${{ secrets.RAINDROP_TOKEN }}
          RDCLI_API_DELAY_MS: "250"
        run: bun run test:live

      - name: Post success comment
        if: github.event_name == 'issue_comment' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '✅ Live tests passed!'
            });

      - name: Post failure comment
        if: github.event_name == 'issue_comment' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '❌ Live tests failed. [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            });
