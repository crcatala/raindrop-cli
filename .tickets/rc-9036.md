---
id: rc-9036
status: open
deps: []
links: []
created: 2026-01-18T01:39:04Z
type: feature
priority: 2
assignee: cc-vps
tags: [enhancement, dx]
---
# Adopt CLI playbook patterns: structured errors, exit codes, signal handling

## Summary

After comparing raindrop-cli with the cli-playbook patterns from research-learning-agent, identified 3 improvements worth adopting.

## Tasks

### 1. Structured Error Classes with `toJSON()`

Enhance `src/utils/errors.ts` with typed error classes that support JSON serialization:

```typescript
export class CliError extends Error {
  constructor(
    message: string,
    public code: string,        // 'API_ERROR', 'USAGE_ERROR', 'TIMEOUT', etc.
    public exitCode = 1,
    public details?: Record<string, unknown>,
  ) {
    super(message)
    this.name = 'CliError'
  }

  toJSON(): Record<string, unknown> {
    return {
      error: true,
      code: this.code,
      message: this.message,
      ...(this.details && { details: this.details }),
    }
  }
}

// Subclasses
export class UsageError extends CliError { ... }  // exitCode: 2
export class ApiError extends CliError { ... }    // exitCode: 1
export class TimeoutError extends CliError { ... }
export class ConfigError extends CliError { ... }
```

Update `cli-main.ts` to output JSON errors when `--json` is set:

```typescript
if (jsonOutput && isCliError(error)) {
  stderr.write(`${JSON.stringify(error.toJSON(), null, 2)}\n`)
  setExitCode(error.exitCode)
  return
}
```

### 2. Exit Code 2 for Usage Errors (clig.dev compliance)

Per [clig.dev](https://clig.dev/#exit-codes):
- Exit code 0: Success
- Exit code 1: General errors (API failures, etc.)
- Exit code 2: Usage errors (invalid arguments, missing required options)

Currently `cli-main.ts` already uses exit code 2 for `CommanderError`, but ensure all usage-related errors (validation failures, missing args) use exit code 2.

### 3. Signal Handling for Graceful Shutdown

Add to `cli-main.ts`:

```typescript
function setupSignalHandlers(
  stderr: NodeJS.WritableStream,
  exit: (code: number) => void
): void {
  let interrupted = false

  process.on('SIGINT', () => {
    if (interrupted) {
      // Second Ctrl-C: force exit
      stderr.write('\nForce exiting...\n')
      exit(130)
      return
    }
    interrupted = true
    stderr.write('\nInterrupted. Press Ctrl-C again to force exit.\n')
    // Give cleanup 3 seconds, then exit
    setTimeout(() => exit(130), 3000)
  })

  process.on('SIGTERM', () => {
    stderr.write('\nTerminated.\n')
    exit(143) // 128 + SIGTERM(15)
  })
}
```

Call `setupSignalHandlers(stderr, exit)` at the start of `runCliMain()`.

## Acceptance Criteria

- [ ] `CliError` base class with `code`, `exitCode`, `details`, and `toJSON()`
- [ ] Subclasses: `UsageError` (exit 2), `ApiError`, `TimeoutError`, `ConfigError`
- [ ] `--json` mode outputs structured error JSON on failure
- [ ] All usage/validation errors exit with code 2
- [ ] SIGINT handler with double-Ctrl-C force exit
- [ ] SIGTERM handler with clean exit (143)
- [ ] Tests for error serialization and exit codes

## References

- cli-playbook patterns from `research-learning-agent` repo
- [clig.dev exit codes](https://clig.dev/#exit-codes)
- [clig.dev signals](https://clig.dev/#signals)
